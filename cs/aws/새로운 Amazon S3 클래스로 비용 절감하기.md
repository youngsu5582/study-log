# 새로운 Amazon S3 클래스로 비용 절감하기

- 영상 링크 : https://youtu.be/XvWhhxvdiIQ?si=OXgQBMtLmemyinjK

두 가지 주제가 하나의 영상으로 구성되어 있다.

# Amazon S3 비용 최적화 모범 사례
## S3 스토리지 클래스의 역사

![](https://i.imgur.com/nvh7uhl.png)

고객들의 데이터 액세스 패턴이 변화할 때 적절히 적용할 수 있게 추가하며, 수많은 S3 클래스들이 나왔다.

해당 발표 기준(AWS Summit Korea 2022)

![](https://i.imgur.com/SLeWm84.png)

7개의 스토리지 클래스, 하이브리드 환경 위한 1개의 outputs 클래스로 이루어져 있다.
Eleven-nine 내구성 제공, 3개 이상 가용 영역에 분산되어 저장

오른쪽으로 갈 수록, 오브젝트 저장 비용은 감소하나 복구 비용이 높아져간다.
### Intelligent-Tiering

가장 접근이 빈번한 오브젝트는 Frequent Access Tier 에 위치
-> 30일 이상 접근이 없으면 해당 오브젝트 Infrequent Access Tier 에 넘김
-> 추가로, 60일 이상 접근이 없으면 다시 Archive Instant Access Tier 에 옮김

접근이 없는 오브젝트들의 저장비용이 알아서 자동으로 줄어듬
접근 패턴 분석하기 위해서, 모니터링이 필요하므로 모니터링 비용이 든다.

128KB 이하는 128KB 로 비용 간주

### Standard

가장 일반적인 클래스, 자주 액세스 되는 데이터를 저장할 때 사용

- 저장비용이 비싸고, 파일 복구 비용은 없다

### Glacier Flexible Retrieval

기존의 Glacier 클래스
상위 Glacier Instant Retrival 가 생기면서 벌크복구 비용이 무료로 바뀜


### 적당한 결론

오브젝트 데이터 빈도에 따라 적절히 클래스를 선택해 비용을 절감할 수 있다.

매일 접근? -> 스탠다드 클래스
한달에 한번 접근? -> 스탠다드 IA(Infrequent Access) 클래스
분기당 한번? -> Glacier Instant Retrieval 클래스
반 년, 일 년에 한번? -> Glacier Flexible Retrieval 클래스
수 년에 한번...? -> Glacier Deep Archive 클래스

> 아래는, AWS 리전 >= 가용 영역이 아닌, 단일 리전에 저장하는 요소

- 원존 IA 클래스
  -> Eleven-Nine 은 제공하나, 하나의 가용 영역에만 데이터 저장하기 때문에 자주 접근하지 않고 재생산 가능한 데이터만 넣어두는걸 기대

- 아웃포스트

S3 스토리지를 고객 IDC 에 두는 것
-> 자신의 데이터를 로컬 네트워크에서 접근 가능

## Glacier Instant Retrieval

이번 발표의 주제, 새로 나온 클래스

아카이브 데이터를 위한 저장소이나, 오브젝트 액세스를 스탠다드 클래스만큼 빨리 접근할 수 있는 클래스

- 밀리초 단위 오브젝트 접근
- 오브젝트는 최소 90일 이상 저장 기간 가짐
- GB 단위당 오브젝트 복구 비용 발생

### 왜 나오게 되었는가?

현재, 모든 산업에서 수많은 데이터를 생산하고 저장을 하고 있다.
저장 비용을 줄이기 위해 접근 빈도가 낮은 데이터들은 아카이브 스토리지 or 테잎등에 별도 보관을 하고 있었다.
-> 복구 시간이 오래 걸림

하지만, 실제 업무는 몇 년에 한번 접근해도 필요할 때는 파일을 빨리 접근해야 하는 경우가 많다.
( 병원에서 수개월, 수년만에 내원한 환자라던가.. 올림픽 영상, 뉴스가 4년 만에 찾는다던지... )

### 특징

- 월 GB 당 $0.005 ( 발표 기준에도, 현재 기준에도 )
  스탠다드가 $0.025 -> $0.024 -> $0.023 이라는걸 가정하면 매우 싸다. (5배의 차이므로)

- 밀리초 접근, 99.9% 가용성 설계, Elevent-Nine 내구성 설계
  스탠다드 클래스 & 스탠다드 IA 클래스와 동일한 latency & throughput 성능 제공

## 아카이브 스토리지 선택

![](https://i.imgur.com/THWbO14.png)

> 왠만하면, Glacier Instant Retrieval 이 나쁘지 않은 선택..

최소 오브젝트 보우 기간의 의미?
-> 해당 기간 이전에 오브젝트를 삭제해도 최소 보유기간 만큼 비용이 부과된다는 의미

![](https://i.imgur.com/E4qfPDe.png)

인텔리전트 티어링을 적용중이라면?
-> Glacier Instant Retrieval 비용 절감 효과를 누린다.

자동으로 액세스 패턴을 분석해 오브젝트 티어 변경

- Glacier Instant Retrieval 클래스가 도입되며, 새로 `Archive Instant Access tier` 추가
- `Deep Archive Access tier` 는 옵션으로, 더욱 비용을 아끼고 싶다면 사용 가능

---

# Amazon S3 비용 최적화 모범 사례

## 저장 비용과 접근 속도 간 균형 유지의 어려움

데이터가 기하급수적으로 늘어나, 비용 효율적이며 데이터를 중요 가치로 전환할 수 있는 데이터 아키텍처가 필요해짐
추가로, `데이터 레이크`, `아카이브`, `백업 & 복원`, `재해 복구` 와 같은 다양한 워크 로드도 처리를 요구하게 되었다.

> 데이터 레이크?
> - 원천 데이터를 그대로 저장, 일단 저비용 & 대용량 스토리지에 저장, 차후 분석용 사용 가능, 저장 - 계산 분리용

## 다시 한번 S3 의 소개

- 사실상 무제한의 확장성
- 최상의 성능, 최고의 안전성
- 관리 편의
- 아카이브 데이터에 대한 가장 저렴한 스토리지 제공
- 16년 간의 혁신 (새로운 클래스의 꾸준한 추가)

### 분석 방법

![](https://i.imgur.com/6YfJUcY.png)

2개의 버킷이 있고, 동일한 용량이라 가정

즉
오브젝트의 크기가 큰 버킷은? - 상대적 적은 수 오브젝트 존재
오브젝트의 크기가 작은 버킷은? -> 상대적 많은 수 오브젝트 존재

두 버킷의 저장 비용은 동일하나,
오브젝트 수당 발생하는 요청 비용, 수명 주기 전환 비용이

오브젝트 수가 많은 버킷일수록 더 많이 발생할 것이다.

- 크기가 작은 파일들을 S3 올리기 전, 묶어서 압축하면 이득을 볼 수 있음
- EMR 도구를 통해 합치는 작업을 하면 요청 비용을 감소시킬 수 있음
### 비용 최적화 요소

![](https://i.imgur.com/9tK0sQz.png)

데이터 용량, 평군 오브젝트 크기, 데이터 검색 비용, 데이터 수명

- 평균 오브젝트 크기 : get, put 같은 여러가지 요청 비용과 수명 주기 전환 비율 결정 짓는 주요 요인
- 검색 비용 : Standard 는 적용되지 않으나, Glacier Instant Retrieval 클래스에서는 청구 되므로 주요 요인
- 데이터 수명 : Glacier Instant Retrieval 은 무조건 90일 이상 데이터 수명 보장 - 삭제해도, 비용 발생

![](https://i.imgur.com/bu7Kju1.png)

(위와 비슷함)

여전히, 평균 오브젝트 크기를 확인하는 것이 중요 분석 방법이다.
기존과 달리
`128KB 미만 오브젝트 모니터링 비용 청구 X` + `최소 30일 저장`  제약이 없어짐

> 추가로, 팁이라면 수명 주기를 통해 오브젝트를 Intelligent-Tiering 클래스로 옮기는 것보다
> S3 업로드 시 해당 클래스에 바로 넣는것이 좋음
> (추가적 발생하는 수명 주기 전환 비용 절약)

### Storage Lens

스토리지 상태를 대시보드 형태로 가시성 있게 보여주는 대시보드

![](https://i.imgur.com/FK6a9QI.png)

- 가로축이 평군 오브젝트 크기
- 세로축이 오브젝트 수
- 원의 크기가 데이터 용량

=> 그래프 우측에 위치 + 원의 크기가 큰 버킷일수록 아카이브 스토리지를 이용하면 비용 절감 효과를 볼 수 있다.

- 전 조직 아우르는 가시성

멤버 계정 버킷 정보도 함께 볼 수 있음

- 15가지 Usage 지표, 14가지 Activity 지표
- 리전, 스토리지 클래스, 버킷, Prefix 단위로 세부 분석

기본 대시보드는 무료로 사용 가능
유료인 `Advanced metrics and recommendations` 선택하면
put, get request 등 Activity 지표 추가적 제공 + prefix 단위 분석 또한 가능

- 비용 효율성 및 데이터 보호 모범 사례

Storage Lens 를 통해 Incomplete Multipart Upload S3 를 파악 가능하다.

> Incomplet Multipar Uplaod :
> 파일이 작은 조각으로 업로드되지만, 업로드가 중단되며 파일이 조립되지 않은 상태로 남아있는 파일들
> -> 보이지 않는 추가 비용을 발생시킴

#### Storage Lens 비용

> 발표에는 없었지만, 내가 궁금해서 찾아본 내용

![](https://i.imgur.com/88wBnYo.png)



### Storage Class Analysis

![](https://i.imgur.com/XH0Hk89.png)

오브젝트 검색 비율, 수명 등 확인 가능하다.

30~45 일 동안 Storage Class Analysis 실행하면, 오브젝트 수명 기준으로
오브젝트가 자주 접근되지 않는 시기 결정할 수 있다.

-> 접근 빈도 낮은 데이터를 식별후 수명 주기 정책을 설정해, 이러한 데이터를 더 저렴한 스토리지 클래스로 전환
(적용 대상은 전체 버킷 선택도 가능, 특정 Prefix 단위로도 선택 가능)

## S3 비용 최적화 모범 사례 - 적용

### 예측 가능한 액세스 패턴 가진 데이터 수명 주기 전환하기

수명 주기 규칙은 `오브젝트 저장 기간` 에 기초해 실행

- 90일 이상 오래된 데이터는 S3 Glacier Instant Retrieval 로 이동
- 365일 이상 오래된 데이터는 S3 Glacier Deep Archive 로 이동

(즉, 적절히 클래스를 변환하며 장기적 비용을 절감시킬 수 있음)

클래스 별 제약사항이 있을수도 있다.

- 128KB 보다 작은 오브젝트는 Standard 에서 Glacier Instant Retrieval, Intelligent-Tiering 으로 넘어가지 않는다
- Standard에서 Standard-IA 로 전환할 때는 최소 30일 동안 Standard 에서 보관되어야 한다

![](https://i.imgur.com/DmlJRmh.png)

추가로 생각해야 하는 점은
오브젝트를 전환하는 비용도 동시에 발생한다는 것이다.

-> 저장비용과 클래스 전환 비용 모두 고려해서 수명 주기 규칙을 설정해야 한다!

- 저장 비용은 매달 정기적 발생
- 전환 비용은 딱 한번만 발생

#### 구체적 사례

![](https://i.imgur.com/I9syExA.png)

- 천 만개의 작은 오브젝트 (~40KB)
- 백 만개의 중간 오브젝트 (~200KB)
- 십 만개 큰 오브젝트 (~10MB)

모든 오브젝트를 Deep Archive 로 넘긴다면
일회성으로 발생하는 과도한 전환 비용으로 15개월 동안은 Glacier Deep Archive 에 보관해야만 최종적 비용을 절감할 수 있게 된다.

오브젝트 크기 필터를 이용한다면?

![](https://i.imgur.com/KVx5nGN.png)

작은 오브젝트를 필터링하면, 4개월 동안 유지해도 비용 절감 효과를 볼 수 있다.

### S3 Intelligent-Tiering 아카이브 사용

데이터 액세스 패턴이 일정하지 않고
불규칙적, 패턴에 대한 인사이트가 없다면 사용해볼 수 있다.

일정 기간 동안 접근이 없으면, 자동으로 좀 더 저렴한 티어로 오브젝트를 전환 시킨다.
`+` 전환 비용도 받지 않는다.

하지만, 각각 오브젝트 대한 모니터링 비용이 매달 발생한다.

> 사실상, trade-off...
> Infrequent Access Tier 대비 72% 비용 절감할 수 있다.

## 이벤트 알림 기반, 비동기 아카이브로 이동된 오브젝트 추적

![](https://i.imgur.com/J3msHQc.png)

S3에서 제공하는 이벤트 알림 이용해 오브젝트가 아카이브 티어로 이동되었을 때 알림 받을 수 있다.

EX) 미디어 사업을 한다면, 어떤 영상이 바로 플레이 가능한지 필요할 수 있다.

- DB 에 이런 상태를 저장
- 아카이브  티어 넘어가는 오브젝트 발생하면 이벤트 알림이 Lambda 실행
- DB 업데이트 해서 영상들 접근성 관리














