![](https://i.imgur.com/xVUMXUY.png)

S3 은 스토리지 클래스 간 전환 위해 폭포형 모델 지원

128KB 미만 객체는 어떤 스토리지 클래스로도 전환 X
-> 소형 객체는 오히려 전환 비용이 스토리지 절감액보다 클 수 있음

> 2024년 9월부터 스토리지 클래스로 전환되는 것을 금지

## 수명 주기

객체 생애주기 동안 특정 시점에 자동으로 전환, 아카이브, 삭제 같은 작업을 수행하도록 예약하는 정책
버킷 단위 정의 + 접두사, 태그, 객체 크기 등을 조건으로 조합할 수 있다.

- 정책 추가, 수정해도 즉시 반영되지 않고 수분 정도의 전파 지연이 있을수 있음

### 수명 주기 고려 사항

- 수명 주기 구성 전파 지연

버킷에 S3 수명 주기 구성을 추가할 때 완전 전파까진 지연 시간이 존재한다.
`+` 수명 주기 구성을 삭제할 때도 발생

- 이전 or 만료 지연

글에 따르면, 실제 삭제 & 전환이 이루어지기 까지 며칠이 걸릴 수도 있다고 한다.
하지만, 과금은 조건 충족 시점에 따라 미리 변경되어 적용된다.

- 기존 객체에도 새 규칙이 바로 적용

접두사 필터 새로 추가하면, 이미 존재하는 객체들이 전환/삭제 대기열에 들어간다.

## 예제

### CLI

```json
{
  "Rules": [
	{
	  "ID": "logs-cold-storage",
	  "Status": "Enabled",
	  "Filter": { "Prefix": "logs/" },
	  "Transitions": [
		{ "Days": 30, "StorageClass": "STANDARD_IA" },
		{ "Days": 120, "StorageClass": "GLACIER" }
	  ],
	  "Expiration": { "Days": 365 }
	}
  ]
}
```

JSON 형태로도 수명 주기 규칙을 적용할 수 있다.

```sh
aws s3api put-bucket-lifecycle-configuration \
	--bucket <버킷명> \
    --lifecycle-configuration <JSON 파일경로>
```

와 같이 적용가능

```sh
aws s3api get-bucket-lifecycle-configuration \
	 --bucket <버킷명>
```

확인 가능

```sh
aws s3api delete-bucket-lifecycle \
	--bucket <버킷명>
```

> CLI 는 JSON 만 허용

### SDK

```java
S3Client s3 = S3Client.builder()
	.region(Region.AP_NORTHEAST_2)
	.credentialsProvider(ProfileCredentialsProvider.create("mfa"))
	.build();

LifecycleRule rule = LifecycleRule.builder()
	.id("logs-cold-storage")
	.status(ExpirationStatus.ENABLED)
	.filter(LifecycleRuleFilter.builder()
		.prefix("logs/")
		.build())
	.transitions(Transition.builder()
		.days(30)
		.storageClass(StorageClass.STANDARD_IA)
		.build(),
		Transition.builder()
		.days(120)
		.storageClass(StorageClass.GLACIER)
		.build())
	.expiration(LifecycleExpiration.builder()
		.days(365)
		.build())
	.build();
LifecycleConfiguration config = LifecycleConfiguration.builder()
	.rules(rule)
	.build();

s3.putBucketLifecycleConfiguration(PutBucketLifecycleConfigurationRequest.builder()
	.bucket(bucketName)
	.lifecycleConfiguration(config)
	.build());
```

CLI 와 매커니즘은 동일하게 적용

- [PutBucketLifecycleConfiguration](https://docs.aws.amazon.com/AmazonS3/latest/API/API_PutBucketLifecycleConfiguration.html)
- [GetBucketLifecycleConfiguration](https://docs.aws.amazon.com/AmazonS3/latest/API/API_GetBucketLifecycleConfiguration.html)
- [DeleteBucketLifecycle](https://docs.aws.amazon.com/AmazonS3/latest/API/API_DeleteBucketLifecycle.html)

> Builder 패턴으로 적용

## 수명 주기 문제 해결

### 수명 주기 규칙에 따라 취해진 조치를 모니터링 하려면?

- S3 이벤트 알림 - 수명 주기 만료 or 이전 이벤트 등에 대해 S3 이벤트 알림 설정
- S3 서버 액세스 로그 - 서버 액세스 로그 활성화해 관련된 작업들을 캡처

수명 주기 작업으로 인한 스토리지 변경 매일 확인하고 싶다면 S3 Storage Lens 대시보드를 이용하는걸 추천

[Amazon S3 스토리지 렌즈 지표 용어집](https://docs.aws.amazon.com/ko_kr/AmazonS3/latest/userguide/storage_lens_metrics_glossary.html)

에서 대시보드가 제공해주는 지표들을 확인할 수 있다.

> 전환 자체 Count 는 유료 라고 한다.
> (각 클래스 별 사용량은 무료로 볼 수 있음)

### 버저닝이 켜져있으면?

- 현재 버전이 만료된다면, 삭제 마커만 추가된다. - 객체 수가 오히려 늘어남

LifeCycle 걸었는데 ObjectCount 가 안 줄어들면 대부분 이 케이스

### Lifecycle 삭제를 되돌릴 수 있나..?

수명 주기로 만료된 객체는 버전 관리가 켜져있지 않으면 복구가 어려울 수 있다!!

### Bucket Policy Deny 와 Lifecycle

Lifecycle 은 내부 시스템 작업이라
`s3:DeleteObject` Deny 같은 버킷 정책으로 막히지 않는다.

-> Lifecycle rule 자체를 비활성/수정/삭제 해야 한다