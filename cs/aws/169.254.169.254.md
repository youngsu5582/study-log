인스턴스 내부 or EC2 콘솔 등에서 인스턴스 메타데이터에 접근가능하게 해준다.

- 요소들은 텍스트 ( `text/plain` ) 으로 반환
- 링크 로컬 주소 방식으로 동작

> 링크 로컬 주소?
> 같은 네트워크, 브로드캐스트 도메인에서만 통신이 유효
> ( 외부로 나가면, 같은 네트워크가 아니므로 라우터 패킷 전송 X )


`http://169.254.169.254/latest/meta-data/` 에 요청을 보내면 폴더 형식으로 정보들을 제공해준다.

![](https://i.imgur.com/txh27nP.png)

인스턴스 내부에서 실행되는 애플리케이션이 어떤 환경에서 실행되고 있는지 동적으로 파악 & 조정 할 수 있게 해준다.

```shell
LOCAL_IP=$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)  
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
```

와 같이 조회를 한 후

```shell
APP_OPTS+=" --server.private.ip=${LOCAL_IP} --server.public.ip=${PUBLIC_IP}"
```

환경변수를 설정하고 구동할 수 있다.

### IMDS

- V1 : HTTP GET 요청으로 직접 메타데이터 검색, SSRF ( Server-Side Request Forgery ) 취약점 애플리케이션 or 인스턴스 접근할 수 있는 소프트웨어가 메타데이터 탈취하면 IAM 자격 증명을 획득할 위험이 생긴다.

> SSRF : 공격자가 서버 측에서 의도하지 않은 위치로 HTTP 요청 보내게 조작

- V2 : 요청 전에 먼저 세션 토큰 ( TTL 을 가짐 ) 을 요청해야 한다.

`TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")`

그 후, `curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/instance-id`
토큰을 담아서 GET 요청을 보낸다.

### 사용사례

- 자동 스케일링 그룹 : 새 인스턴스 시작 시, 메타데이터 통해 그룹 정보를 얻고 애플리케이션 설정
- 모니터링 & 로깅 : 로그에 주소를 남긴다던가, 슬랙 알림 보낼때 정보를 담을 수 있다던가
- 서비스 디스커버리 : IP 주소, 포트 정보등을 가져와 서비스 레지스트리에 등록
- 데이터베이스 연결 : 환경 따라 다르게 DB 연결해야 할 때 동적 설정
