# JPA

Java Persistence API
DB 테이블이 아닌, 자바 객체를 다뤄, 객체지향 설계 및 유지보수를 용이하게 해준다.

- 객체지향 프로그래밍 같은 접근 : DB 대신 자바 객체를 다루므로, 객체지향 설계 및 유지보수 용이
- 생산성 향상 : SQL 쿼리 직접 작성하지 않고, 어노테이션 + API 통한 데이터 조작으로 코드 양 및 복잡도 줄여줌
- DB 독립성 : 특정 DB 종속적이지 않으므로, 유지보수 및 이식성 좋음
- 트랜잭션 관리 : 선언적 트랜잭션 통해 트랜잭션 쉽게 관리 가능

## 영속성 컨텍스트

엔티티 매니저가 관리하는 일종의 개시

DB와 애플리케이션 간 중간 매개체 역할

- 엔티티 상태 관리 : 객체가 특정 상태를 가지며, 상태에 따라 DB 동기화가 이루어짐
- Dirty Checking : 엔티티 상태 변경을 감지해 트랜잭션 커밋 시점 자동 업데이트 쿼리 생성해 반영
- 동일성 보장 : 동일 트랜잭션 내 동일 엔티티 대해 항상 같은 인스턴스 제공, 데이터 일관성 유지

### 엔티티 생명주기

- 비영속 ( Transient ) : 아직 영속성 컨텍스트에 포함되지 않은 상태, 단순 자바 객체로 존재
- 영속 ( Managed ) : 엔티티 매니저에 의해 관리되고, DB 와 동기화될 대상, 영속성 컨텍스트에 포함
- 준영속 ( Detached ) : 한때 영속 속했으나, 현재는 분리되어 관리되지 않는 상태
- 삭제 ( Removed ) : 삭제 명령 받아 트랜잭션 커밋 시 DB 삭제될 에정인 상태

- persist : 비영속 상태 -> 영속 상태로 전환
- remove : 엔티티 삭제 대상 전환, 트랜잭션 커밋 시 실제 삭제
- detach or 엔티티 매니저 종료 : 영속 상태 -> 준영속 상태 전환
- merge : 준영속 상태 엔티티 다시 영속 상태로 가져온다.

## Lazy, Eager

- Lazy Loading
    - 연관된 엔티티를 컬렉션 실제 사용할 때까지 로딩 X
    - 초기 쿼리 실행 시 부하 감소 + 추가 쿼리 발생 가능 ( N+1 )

- Eager Loading 
    - 연관된 엔티티 모두 로딩
    - 한번에 가져오므로, 성능 상 이점이 있지만 불필요한 데이터 미리 로딩 가능성 존재

## 연관관계

- OneToOne : 1:1 관계, 두 엔티티 서로 참조`
- OneToMany : 1:N 관계, 한 엔티티가 여러 엔티티 참조, 주로 컬렉션 형태 관리
- ManyToOne : N:1 관계, 여러 엔티티가 한 엔티티 참조, 성능 최적화 형태와 방향성에 따라 단방향으로 사용
- ManyToMany : N:N 관계, 중간 테이블 통해 관리 + 단방향 역시도 가능

주인 엔티티가 외래키 관리, DB 업데이트 시 참조 관계 반영
비주인 엔티티가 mappedBy 속성 사용해 매핑 관계 정의

```java
@ManyToOne(fetch = FetchType.LAZY)
@JoinColumn(name = "team_id")
private Team team;
```
주인 ( 실제 값을 가짐 )

```java
 @OneToMany(mappedBy = "team", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Member> members = new ArrayList<>();
```
비주인 ( 실제 값을 가지지 않음 )

## Dirty Checking

영속성 컨텍스트 내 엔티티 변경사항 자동 감지, 트랜잭션 커밋 시점에 변경된 DB만 업데이트 하는 기능

- 엔티티가 영속 상태로 전환될 때, 초기 상태 ( 스냅샷 ) 보관
- 트랜잭션 내 엔티티 필드 변경 시, 스냅샷과 비교해 변경된 필드를 찾아 해당 엔티티에 UPDATE 쿼리 실행
- 엔티티 상태 변경만으로 DB 동기화

## 캐싱

### 1차 캐시

엔티티 매니저 내부에서 관리
동일 트랜잭션 내 동일 엔티티 여러 번 접근할 때 DB 조회 줄어듬
트랜잭션 소멸 시 자동 소멸

### 2차 캐시

애플리케이션 전체, 여러 트랜잭션 걸쳐 공유되는 캐시로 읽기 전용 데이터에서 사용
2차 캐시 제공 위한 여러 전략 제공 ( Ehcache, Infinispan 등등 ) 지원

빈번히 조회되나 변경되지 않은 경우, 2차 캐시 사용해 DB 부하 줄임
캐시 일관성 유지위해 적절히 캐시 정책과 만료 정책 수립

## 단점

- 학습 곡선 : JPA 내부 동작, 영속성 컨텍스트 및 매핑 전략 등 복잡한 개념이 존재해 학습에 시간이 필요하다.
- 성능 이슈 : 잘못된 연관관계, 로딩 전략, N + 1 문제 등 성능문제가 발생한다.