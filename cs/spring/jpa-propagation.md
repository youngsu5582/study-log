# JPA Propagation

JPA 어노테이션을 통해, DB의 PROPAGATION 과 ISOLATION 을 지정할 수 있다.

## Transaction Propagation

세션의 트랜잭션을 Spring 이 어떻게 이용할지에 대한 설정이다.

### REQUIRED

기본 Propagation
- 트랜잭션 존재 : 기존 트랜잭션 이용
- 트랜잭션 미 존재 : 신규 트랜잭션 생성

가장 무난하게 사용 가능하다.

### SUPPORTS

- 트랜잭션 존재 : 기존 트랜잭션 이용
- 트랜잭션 미 존재 : 트랜잭션 없이 수행

왜 사용해야 하지..?

### MENDATORY

- 트랜잭션 존재 : 기존 트랜잭션 이용
- 트랜잭션 미존재 : Exception 발생

꼭 이전 트랜잭션이 보장되어야 하는 경우 사용한다.
예를 들어, 결제 로직에서 부분별로 분리를 했을때
-> 없으면, 새로운 트랜잭션을 만드는게 아닌 트랜잭션의 단계

### NEVER

- 트랜잭션 존재 : Exception 발생
- 트랜잭션 미존재 : 정상적으로 트랜잭션 없이 수행

트랜잭션 없을때만 작업이 진행되어야 할 때

사실상, 그냥 트랜잭션 어노테이션 선언 안하면 되지 않을까..?

### NOT_SUPPORTED

- 트랜잭션 존재 : 트랜잭션 종료될 때 까지 대기한 후, 트랜잭션 종료되고 나면 실행
- 트랜잭션 미존재 : 트랜잭션 없이 진행

기존 트랜잭션에 영향을 주지 않아야 할 때 사용

이 역시 굳이...?

### REQUIRES_NEW

- 트랜잭션 존재 : 트랜잭션 종료 때 까지 대기한 후, 새로운 트랜잭션 생성하고 실행
- 트랜잭션 미존재 : 신규 트랜잭션 생성하고 로직 수행

이전 트랜잭션과 구분하여 새로운 트랜잭션으로만 처리가 필요할때 사용

상품이 판매된다면?
-> 그 후, 처리해야하는 로직들이나 같이 묶여서 처리가 될 필요가 없는 경우
( 결제 후, 판매 키워드 또는 판매 목록에서 제외 등등 )

즉, 해당 결과가 기존 트랜잭션에 영향을 주지 않아야 할 떄 사용한다.
내부에서 예외 발생하면 새로운 트랜잭션만 롤백

### NESTED

- 트랜잭션 존재 : 현재, 트랜잭션에 Save Point 걸고, 이후 트랜잭션 수행
- 트랜잭션 미존재 : REQUIRED 와 동일하게 신규 트랜잭션 생성하고 로직 수행

DBMS 특성 따라 지원하거나 미지원한다.

전체 트랜잭션은 커밋되나, 중간 작업만 롤백
-> savepoint 이전까지 커밋된 데이터가 외부 트랜잭션에 반영될 수 있음

---

일반적으로, CheckedException 은 의도된 예외라고 생각해서 트랜잭션 롤백을 하지 않는다.
대신, UncheckedException 은 의도되지 않은 예외이므로 트랜잭션 롤백을 한다.

-> 예외 발생 시 반드시 롤백되야 하는 경우, 예외 유형 상관없이 rollbackFor 명시에 예와 상황을 명확히 하자.

### rollbackFor

해당 CheckedException 발생하면, 롤백 지정

### noRollbackFor

기본적으로 롤백 되야 하는 예외에 대한 롤백 방지