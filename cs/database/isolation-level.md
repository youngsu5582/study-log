# Isolation Level

여러 트랜잭션이 동시에 처리될 때
특정 트랜잭션이 다른 트랜잭션에서 변경하거나 조회하는 데이터를 볼 수 있게 허용하는지 여부 결정

SERIALIZABLE -> REPEATABLE READ -> READ COMMITTED -> READ UNCOMMITTED

## SERIALIZABLE

가장 엄격한 격리 수준
트랜잭션을 순차적 실행
-> 동시 처리 성능이 매우 떨어진다.

순수 SELECT 작업에도 대상 레코드에 넥스트 키 락을 `읽기 잠금`으로 건다.
-> 다른 트랜잭션에서 절대 추가/수정/삭제 불가능

## REPEATABLE READ

변경 전 레코드를 UNDO 공간에 백업한다.
( 변경 전 / 후 데이터 모두 존재 )
동일한 레코드에 대해 여러 버전 데이터가 존재하기에 MVCC ( Multi Version Concurrency Control ) 이라 부른다.

### MVCC

트랜잭션이 롤백된 경우에 데이터 복원
서로 다른 트랜잭션 간에 접근할 수 있는 데이터 세밀하게 제어

> 각각의 트랜잭션은 순차 증가하는 고유한 트랜잭션 번호가 존재한다.
> 백업 레코드에는 어느 트랜잭션 의해 백업되는지 트랜잭션 번호를 함께 저장
> 불필요하다 판단하는 시점에 주기적으로 백그라운드 스레드 통해 삭제

트랜잭션 내 동일한 결과 보장하지만, 새로운 레코드가 추가되는 경우에는 부정합이 생긴다.
-> PHANTOM READ

```sql

SELECT * FROM MEMBER WHERE id>=50;

INSERT INTO MEMBER (id,name) VALUES (51,"Joyson")
```

자신보다 나중에 실행된 트랜잭션이 추가한 레코드는 무시하면 된다. - 일반적인 조회에선 팬텀 리드 발생 X

MySQL 에선 갭 락이 존재한다.

1. B가 먼저 데이터 조회하기 위해 `SELECT FOR UPDATE` 를 이용해 쓰기 잠금을 건다. ( `id>=50 FOR UPDATE` )
2. A가 새로운 값을 INSERT 한다. ( `INSERT 51` )
3. B가 다시 조회하면, INSERT 한 값이 나온다.

잠금을 포함한 읽기는 언두 로그가 아닌 테이블에서 조회를 수행한다.
( 테이블에 변경이 일어나지 않도록 테이블에 잠금 걸고 테이블에서 조회 )

> 언두 로그는 append only 형태이다. - 잠금 장치 X

이런 경우에도 50보다 큰 범위에 갭락으로 넥스트 키 락을 건다.
-> 51 INSERT 는 B 트랜잭션이 종료될 떄 까지 기다린다. ( 또는 락 타임아웃 )

=> 이 역시도 PHANTOM READ 발생 X

1. B가 트랜잭션 시작 후, 잠금없는 SELECT 로 데이터 조회
2. A가 INSERT 통해 데이터 추가 ( 잠금 없으므로 바로 COMMIT )
3. B가 SELECT FOR UPDATE 조회 했다면, 언두 로그가 아닌 테이블로부터 조회

=> 이 때는 PHANTOM READ 발생
사실상, 거의 발생하지 않는다고 보면 된다.

## READ COMMITTED 

커밋된 데이터만 조회

Phantom Read 문제와 Non-Repeatable Read 문제까지 발생한다.

1. B가 처음 `name=Joyson` 과 같이 조회했을때는? -> 결과가 없었음
2. A가 INSERT
3. B가 다시 조회할때는? -> 결과가 존재

반복 읽기를 수행하면, 다른 트랜잭션 커밋 여부 따라 조회 결과가 달라질 수 있다.
일반적으로는 문제가 안되나, 입급된 총 합을 계산하려 할 때 계속해서 입금 내역이 커밋된다면?
-> 조회할 때마다 입금된 내역이 달라진다.

=> 격리 수준이 어떻게 동작하는지, 어떠한 결과가 나오는지 예측해야만 한다.
( 하지만, 애초에 커밋된 데이터만 읽으므로 트랜잭션 내 실행되는 SELECT 와 트랜잭션 밖에서 실행되는 거나 차이가 별로 없다. )

## READ UNCOMMITTED

커밋하지 않은 데이터 조차도 접근할 수 있는 격리 수준
다른 트랜잭션의 작업이 커밋 또는 롤백되지 않아도 즉시 보여준다.

1. A가 INSERT 통해 데이터 추가
2. 커밋 또는 로백 되지 않은 상태여도 B는 데이터에 접근 가능

이와같은 경우를 Dirty Read 라고 한다.
-> 데이터가 조회되다가 사라지는 현상 초래, 시스템에 사실상 불가능한 혼돈 초래
